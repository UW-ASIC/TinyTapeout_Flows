name: Test xschem builds

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        system: [x86_64-linux, aarch64-linux]
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            extra-platforms = aarch64-linux

      - name: Setup QEMU for cross-compilation
        if: matrix.system == 'aarch64-linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static

      - name: Build xschem for ${{ matrix.system }}
        run: |
          nix-build default.nix -A xschem --system ${{ matrix.system }}

      - name: Test xschem version
        if: matrix.system == 'x86_64-linux'
        run: |
          result/bin/xschem --version

  build-darwin:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-13, macos-latest]  # macos-13 is x86_64, macos-latest is aarch64
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build xschem
        run: |
          nix-build default.nix -A xschem

      - name: Test xschem version
        run: |
          result/bin/xschem --version

  build-nixos:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Enter dev shell and test
        run: |
          nix-shell --run "xschem --version"

      - name: Build all custom packages
        run: |
          nix-build default.nix -A xschem
          nix-build default.nix -A netgen
          nix-build default.nix -A ngspice-shared
